#RHEL 6.5 lockdown script based on running SECSCN 6.3 x64

if [ `whoami` != "root" ]; then
        echo "$0 error: you must run this script as root user"
        exit 1
fi

# L1.2
chkconfig --level 12345 auditd on

# L1.8, L1.9, L1.10, L1.11, L1.12
sed -i.bak s/SUSPEND/HALT/g /etc/audit/auditd.conf
sed -i.bak s/INCREMENTAL/SYNC/g /etc/audit/auditd.conf
sed -i.bak s/SYSLOG/email/g /etc/audit/auditd.conf
sed -i.bak s/SUSPEND/email/g /etc/audit/auditd.conf

#L1.14
# Add audit=1 to the end of the kernal lines in /etc/grub.conf

#L1.15, L1.16, L1.17, L1.18, L1.19, L1.20, L1.21, L1.22, L1.23, L1.24, L1.25
#L1.26, L1.27, L1.28
# Need to make sure that it is reading the audit_rules.txt from the right place
echo -e "\n###### Added by RHEL65_lockdown.sh script ######" >> /etc/audit/audit.rules
cat ~/audit_rules.txt >> /etc/audit/audit.rules


# L2.4
chmod 0644 /etc/aliases
chmod 0600 /etc/at.deny
chmod 0600 /etc/audit/audit.rules 
chmod 0600 /etc/audit/auditd.conf 
chmod 0444 /etc/bashrc
chmod 0400 /etc/crontab
chmod 0444 /etc/csh.cshrc
chmod 0444 /etc/csh.login
chmod 0600 /etc/cups/client.conf
chmod 0600 /etc/cups/cupsd.conf
chmod 0444 /etc/hosts
chmod 0600 /etc/inittab
chmod 0640 /etc/login.defs
chmod 0444 /etc/networks
chmod 0600 /etc/ntp.conf
chmod 0444 /etc/profile
chmod 0744 /etc/rc.d/init.d/auditd
chmod 0400 /etc/securetty
chmod 0640 /etc/security/access.conf
chmod 0600 /etc/security/console.perms
chmod 0444 /etc/services
chmod 0444 /etc/shells
chmod 0600 /etc/skel/.bashrc
chmod 0600 /etc/sysctl.conf
chmod 0600 /root/.bash_logout
chmod 0400 /root/.bash_profile
chmod 0400 /root/.bashrc
chmod 0400 /root/.cshrc
chmod 0400 /root/.tcshrc
chmod 0600 /var/log/dmesg
chmod 0400 /var/log/lastlog
chmod 0600 /var/log/wtmp

# L2.5
chmod 0750 /etc/cron.d
chmod 0750 /etc/cron.daily
chmod 0750 /etc/cron.hourly
chmod 0750 /etc/cron.monthly
chmod 0750 /etc/cron.weekly
chmod 0750 /etc/security
chmod 0700 /root
chmod 0700 /var/log/audit

#L2.15, L2.16, L2.17
sed -r -i.bak s/umask\ [0-9]{3}/umask\ 027/g /etc/init.d/functions
sed -r -i.bak s/umask\ [0-9]{3}/umask\ 027/g /etc/profile
sed -r -i.bak s/umask\ [0-9]{3}/umask\ 027/g /etc/csh.cshrc
sed -r -i.bak s/umask\ [0-9]{3}/umask\ 027/g /etc/bashrc

#L2.18 L2.19
cp /etc/fstab /etc/fstab.bak
sed -r -i 's:\/boot.*$:& nodev nosuid:g' /etc/fstab
sed -r -i 's:\/home.*$:& nodev nosuid:g' /etc/fstab

#L2.21, L2.22
sed -i.bak 's/SINGLE=\/sbin\/sushell/SINGLE=\/sbin\/sulogin/' /etc/sysconfig/init
sed -r -i.bak 's/PROMPT=.*/PROMPT=no/' /etc/sysconfig/init

#L3.2
chkconfig acpid off
chkconfig atd off
chkconfig autofs off
chkconfig avahi-daemon off
chkconfig bluetooth off
chkconfig cups off
chkconfig mdmonitor off
chkconfig netfs off
chkconfig nfslock off
chkconfig rhnsd off
chkconfig rpcgssd off

#L3.5
sed -i.bak /ftp/d /etc/passwd

#L3.10
echo -e "\n###### Added by RHEL65_lockdown.sh script ######" >> /etc/ssh/ssh_config
cat ~/ssh_config.txt >> /etc/ssh/ssh_config

#L4.1
cp /etc/login.defs /etc/login.defs.bak
sed -r -i 's/PASS_MAX_DAYS.*/PASS_MAX_DAYS 180/' /etc/login.defs
sed -r -i 's/PASS_MIN_DAYS.*/PASS_MIN_DAYS 7/' /etc/login.defs
sed -r -i 's/PASS_WARN_AGE.*/PASS_WARN_AGE 14/' /etc/login.defs
sed -r -i 's/PASS_MIN_LEN.*/PASS_MIN_LEN 8/' /etc/login.defs



